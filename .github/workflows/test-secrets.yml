name: Test Secrets

on:
  workflow_dispatch:

jobs:
  validate-secrets:
    name: Validate repository secrets (non-destructive)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (no code changes)
        uses: actions/checkout@v4

      - name: Verify secrets presence
        shell: bash
        env:
          DISCORD_TOKEN: ${{ secrets.DISCORD_TOKEN }}
          DEPLOY_KEY: ${{ secrets.DEPLOY_KEY }}
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
        run: |
          set -euo pipefail

          echo "Checking presence of commonly-used secrets..."

          check_secret() {
            name="$1"
            value="${!name-}"
            if [ -z "$value" ]; then
              echo "::warning::$name is not set"
              return 1
            fi
            echo "$name: present"
            return 0
          }

          # Check presence
          missing=0
          check_secret DISCORD_TOKEN || missing=1
          check_secret DEPLOY_KEY || missing=1
          check_secret DEPLOY_HOST || missing=1
          check_secret DEPLOY_USER || missing=1

          if [ "$missing" -ne 0 ]; then
            echo "One or more secrets are missing. See warnings above."
            exit 2
          fi

          echo "All required secrets are present. Performing lightweight format checks..."

          # Basic format checks (do not print secrets)
          # DISCORD_TOKEN should be non-empty and not contain whitespace
          if echo "$DISCORD_TOKEN" | grep -q "\s"; then
            echo "::error::DISCORD_TOKEN contains whitespace - probably invalid"
            exit 3
          fi

          # DEPLOY_HOST should look like a hostname or IP (very loose check)
          if ! echo "$DEPLOY_HOST" | grep -Eq "^([a-zA-Z0-9.-]+|[0-9.]+)$"; then
            echo "::error::DEPLOY_HOST doesn't look like a hostname or IPv4 address"
            exit 4
          fi

          # DEPLOY_USER basic check: not empty, no spaces
          if echo "$DEPLOY_USER" | grep -q "\s"; then
            echo "::error::DEPLOY_USER contains whitespace"
            exit 5
          fi

          # DEPLOY_KEY basic sanity: should contain PEM header/footer or start with 'ssh-' for public key
          if echo "$DEPLOY_KEY" | grep -q "^-----BEGIN"; then
            echo "DEPLOY_KEY: looks like a PEM/private key (present)"
          elif echo "$DEPLOY_KEY" | grep -q "^ssh-(rsa|ed25519|dss|ecdsa) "; then
            echo "DEPLOY_KEY: looks like an SSH public key (present)"
          else
            echo "::warning::DEPLOY_KEY doesn't look like a PEM block or an ssh- public key header. It may still be valid (e.g., base64 single-line), but verify manually."
          fi

          echo "Secrets basic validation completed successfully. No secret values were printed."
